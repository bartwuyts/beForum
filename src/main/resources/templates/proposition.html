<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head"></head>
<body>
<div th:replace="fragments/header :: header"></div>

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">
$.ajaxSetup ({
    cache: false
});

function vote(id,direction) {
    jQuery.get('vote', 
                {id: id, direction: direction}, 
                function(data) { $("#votes").text(data); });
}
</script>

<div class="section group">
  <div class="col span_2_of_3">
    <span class="caption" th:text="${proposition.title}">Voorstel</span><br/>
    <span th:text="${#calendars.format(proposition.created,'dd/MM/yy')}+' ingediend door '"></span><a th:href="'/moreinfo/'+${proposition.creator.id}" th:text="${proposition.creator.firstName}+' '+${proposition.creator.lastName}">creator</a>
 </div>
 <div class="col span_1_of_3">
 </div>
</div>

<div class="section group">
  <div class="col span_2_of_3">
    <div th:text="${proposition.text}">Inhoud</div>
	<form method="post">
	 <input type="submit" name="favor" value="Voor" th:disabled="${vote gt 0}" th:class="${vote gt 0}? 'voted' : 'othervoted'"/>
	 <input type="submit" name="against" value="Tegen" th:disabled="${vote lt 0}" th:class="${vote lt 0}? 'voted' : 'othervoted'"/>
	 <textarea name="comment_text" rows="4" cols="50"></textarea>
     <input type="submit" name="comment" value="toevoegen" />
	</form>
	<br/>
	<h3>Commentaren</h3>
	<script th:inline="javascript">
	 function expand(id, propId) {
		 $('#sub_'+id).toggle();
		 $.ajax({
			 url: "/comments/0/"+id,
			 context: $("#subcomments_"+id)
		 }).done(function(data) {
			 if (data.length==0) {
				$(this).html("Geen commentaren");
			 }
			 else {
	            $(this).html("");
	            for (var comment in data) {
                    var created = new Date(data[comment].created);
	            	$(this).append(
	            		'<div class="comment"><div>'+data[comment].text+'</div>'+
	            		'<div class="creator"><a href="/moreinfo/'+data[comment].creator.id+'">'+data[comment].creator.firstName+' '+data[comment].creator.lastName+'</a><span> op '+created.toLocaleString()+'</span></div>'+
	            	    '<img class="expand" src="/expand.png" onclick="expand(&quot;'+data[comment]._id+'&quot;, &quot;'+propId+'&quot;)"/>'+
	            	    '<div id="sub_'+data[comment]._id+'" class="subcomments">'+
	            	     '<form action="/subcomment/'+propId+'/'+data[comment]._id+'" method="post">'+
	            	      '<textarea name="comment_text" rows="4" cols="40"></textarea>'+
	            	      '<input type="submit" name="comment" value="toevoegen" />'+
	            	     '</form>'+
	            	     '<div id="subcomments_'+data[comment]._id+'">Laden...</div>'+
	            		'</div></div>');
	            }
			 }
		 });
	 }
	</script>
	<div class="comments" th:each="comment : ${comments}">
	 <div class="comment">
	  <div th:text="${comment.getText()}">commentaar</div>
      <div class="creator"><a th:href="'/moreinfo/'+${comment.creator.id}" th:text="${comment.creator.firstName}+' '+${comment.creator.lastName}">creator</a><span th:text="' op '+${#calendars.format(comment.created,'dd/MM/yy hh:mm')}"></span><a href="#"> reageren</a></div>
      <img class="expand" src="/expand.png" th:onclick="'expand(\''+${comment._id}+'\',\''+${proposition._id}+'\')'"/>
      <div th:id="'sub_'+${comment._id}" class="subcomments">
       <form th:action="'/subcomment/'+${proposition._id}+'/'+${comment._id}" method="post">
        <textarea name="comment_text" rows="4" cols="40"></textarea>
	    <input type="submit" name="comment" value="toevoegen" />
	   </form>
 	   <div th:id="'subcomments_'+${comment._id}" >Laden...</div>
      </div>
     </div>
    </div>
  </div>

  <div class="col span_1_of_3">
    <div th:replace="fragments/header :: sidebar"></div>
  </div>
</div>

</body>
</html>
