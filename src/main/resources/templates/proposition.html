<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/header :: head"></head>
<body>
<div th:replace="fragments/header :: header"></div>

<script type="text/javascript">
$.ajaxSetup ({
    cache: false
});

function vote(id,direction) {
    jQuery.get('/vote', 
                {id: id, direction: direction}, 
                function(data) { $("#votes").text(data); });
}

function voteComment(id, direction) {
    $.ajax({
        url: "/voteComment/"+id+"/"+direction,
        context: $("#comment_votes_"+id)
    }).done(function(data) {
        $(this).html(data);
    });
}
</script>

<div class="section group">
  <div class="col span_2_of_3">
    <span class="caption" th:utext="${proposition.getTitle()}">Voorstel</span><br/>
    <span th:text="${#calendars.format(proposition.created,'dd/MM/yy')}+' ingediend door '"></span><a th:href="'/moreinfo/'+${proposition.creator.id}" th:text="${proposition.creator.firstName}+' '+${proposition.creator.lastName}">creator</a><span class="official" th:if="${proposition.creator.official}" th:text="${proposition.creator.official}">official</span>
 </div>
 <div class="col span_1_of_3">
 </div>
</div>

<div class="section group">
  <div class="col span_2_of_3">
    <div th:utext="${proposition.text}">Inhoud</div>
	<form method="post">
	 <input type="submit" name="favor" value="Voor" th:disabled="${vote gt 0}" th:class="${vote gt 0}? 'voted' : 'othervoted'"/>
	 <input type="submit" name="against" value="Tegen" th:disabled="${vote lt 0}" th:class="${vote lt 0}? 'voted' : 'othervoted'"/>
	 <textarea class="richinput" name="comment_text" rows="7" cols="80"></textarea>
     <input type="submit" name="comment" value="toevoegen" />
	</form>
	<br/>
	<h3>Commentaren</h3>
	<script th:inline="javascript">
	 function expand(id, propId) {
		 $('#sub_'+id).toggle();
		 $.ajax({
			 url: "/comments/0/"+id,
			 context: $("#subcomments_"+id)
		 }).done(function(data) {
			 if (data.length==0) {
				$(this).html("Geen commentaren");
			 }
			 else {
	            $(this).html("");
	            for (var comment in data) {
                    var created = new Date(data[comment].created);
	            	$(this).append(
	            		'<div class="comment">'+
	                     '<span class="commentvotes">'+
                         '<img class="icon" src="/favor.png" onclick="voteComment(&quot;'+data[comment]._id+'&quot;,1)"/><br/>'+
                         '<span id="comment_votes_'+data[comment]._id+'">'+(data[comment].votesFavor-data[comment].votesAgainst)+'</span><br/>'+
                         '<img class="icon" src="/against.png" onclick="voteComment(&quot;'+data[comment]._id+'&quot;,-1)"/><br/>'+
                        '</span>'+
	            		'<div>'+data[comment].text+'</div>'+
	            		'<div class="creator"><a href="/moreinfo/'+data[comment].creator.id+'">'+data[comment].creator.firstName+' '+data[comment].creator.lastName+'</a><span> op '+created.toLocaleString()+'</span></div>'+
	            	    '<img class="icon" src="/expand.png" onclick="expand(&quot;'+data[comment]._id+'&quot;, &quot;'+propId+'&quot;)"/>'+
	            	    '<span>'+data[comment].childComments+' reacties</span>'+
	            	    '<div id="sub_'+data[comment]._id+'" class="subcomments">'+
	            	     '<form action="/subcomment/'+propId+'/'+data[comment]._id+'" method="post">'+
	            	      '<textarea class="richinput" name="comment_text" rows="7" cols="80"></textarea>'+
	            	      '<input type="submit" name="comment" value="toevoegen" />'+
	            	     '</form>'+
	            	     '<div id="subcomments_'+data[comment]._id+'">Laden...</div>'+
	            		'</div></div>');
	            }
			 }
			 $(".richinput").sceditor({
		            plugins:"bbcode",
		            style:"/sceditor/minified/jquery.sceditor.default.min.css",
		            toolbar:"bold,italic,underline,size,color,image,emoticon",
		            emoticonsRoot:"/sceditor/"});
		 });
	 }
	</script>
	<div class="comments" th:each="comment : ${comments}">
	 <div class="comment">
      <span class="commentvotes">
       <img class="icon" th:id="'comment_favor_'+${comment._id}" src="/favor.png" th:onclick="'voteComment(\''+${comment._id}+'\',1)'"/><br/>
       <span th:id="'comment_votes_'+${comment._id}" th:text="${comment.votesFavor}-${comment.votesAgainst}">tegen</span><br/>
       <img class="icon" th:id="'comment_against_'+${comment._id}" src="/against.png" th:onclick="'voteComment(\''+${comment._id}+'\',-1)'"/><br/>
      </span>
	  <div th:utext="${comment.text}">commentaar</div>
      <div class="creator"><a th:href="'/moreinfo/'+${comment.creator.id}" th:text="${comment.creator.firstName}+' '+${comment.creator.lastName}">creator</a><span class="official" th:if="${comment.creator.official}" th:text="${comment.creator.official}">official</span><span th:text="' op '+${#calendars.format(comment.created,'dd/MM/yy hh:mm')}"></span></div>
      <img class="icon" src="/expand.png" th:onclick="'expand(\''+${comment._id}+'\',\''+${proposition._id}+'\')'"/>
      <span th:text="${comment.childComments}+' reacties'"></span>
      <div th:id="'sub_'+${comment._id}" class="subcomments">
       <form th:action="'/subcomment/'+${proposition._id}+'/'+${comment._id}" method="post">
        <textarea class="richinput comment_textarea" name="comment_text" rows="7" cols="80"></textarea>
	    <input type="submit" name="comment" value="toevoegen" />
	   </form>
 	   <div th:id="'subcomments_'+${comment._id}" >Laden...</div>
      </div>
     </div>
    </div>
  </div>

  <div class="col span_1_of_3">
    <div th:replace="fragments/header :: sidebar"></div>
  </div>
</div>

</body>
</html>
